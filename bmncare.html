<!DOCTYPE html> <!-- Deklarasi dokumen HTML5 agar browser paham standar terbaru -->
<html lang="id"> <!-- Atur bahasa halaman ke Bahasa Indonesia -->
  <head>
    <meta charset="utf-8" /> <!-- Encoding UTF-8 agar semua karakter tampil dengan benar -->
    <meta name="viewport" content="width=device-width,initial-scale=1" /> <!-- Responsif di layar mobile -->
    <title>BMNCARE</title> <!-- Judul tab browser -->
    <link rel="stylesheet" href="css/bmncare.css" /> <!-- Hubungkan file CSS eksternal -->
    <link rel="icon" href="images/bmncare2.ico" type="image/x-icon"> <!-- Favicon di tab browser -->
  </head>
  <body>
    <!-- Script untuk cek izin akses dari localStorage -->
    <script>
  if (localStorage.getItem("izinbmncare") !== "ya") { // Jika tidak ada izin
    alert("Akses ditolak. Silakan buka halaman BMNCARE."); // Tampilkan peringatan
    window.location.href = "https://bmncare.github.io/"; // Alihkan ke halaman utama
  } else {
    localStorage.removeItem("izinbmncare"); // Jika sudah ada izin, hapus token agar hanya sekali pakai
  }
</script>

    <div class="wrap"> <!-- Pembungkus utama -->
      <header>
        <div>
          <h1>BMNCARE - Form Pengajuan Perbaikan</h1> <!-- Judul utama -->
          <p class="lead">"Menjaga Aset, Membangun Negeri"</p> <!-- Tagline -->
        </div>
      </header>

      <!-- Kartu form -->
      <div class="card">
        <!-- Status dan tombol refresh -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div id="status" class="small muted">Memuat data...</div> <!-- Status loading -->
          <button id="refreshBtn" class="btn-refresh" title="Muat ulang data">&#x21bb;</button> <!-- Tombol refresh -->
        </div>

        <!-- Form utama -->
        <form id="bmncareForm" onsubmit="return handleSubmit(event)" autocomplete="off">
          <div class="row">
            <!-- Input pencarian NIP -->
            <div class="input-container">
              <label for="nipSearch">Pilih NIP & Nama</label>
              <input id="nipSearch" placeholder="Ketik untuk mencari NIP..." autocomplete="off" required />
              <div id="nipList" class="dropdown-list"></div> <!-- Dropdown hasil pencarian -->
            </div>
            <!-- Input nama otomatis -->
            <div>
              <label for="nameBox">Nama</label>
              <input id="nameBox" readonly placeholder="Nama akan muncul otomatis" />
            </div>
            <!-- Input barang -->
            <div class="input-container">
              <label for="barangSearch">Barang</label>
              <input id="barangSearch" placeholder="Ketik untuk mencari barang..." autocomplete="off" required disabled />
              <div id="barangList" class="dropdown-list"></div> <!-- Dropdown barang -->
            </div>
            <!-- Input tanggal -->
            <div>
              <label for="tanggal">Tanggal Laporan</label>
              <input id="tanggal" type="date" required />
            </div>

            <!-- Input opsional link foto -->
            <div class="full">
              <label for="linkFoto">Link Foto (opsional)</label>
              <input id="linkFoto" type="url" placeholder="Masukkan URL foto, boleh dikosongkan" />
            </div>

            <!-- Input keterangan kerusakan -->
            <div class="full">
              <label for="keterangan">Keterangan Kerusakan</label>
              <textarea id="keterangan" placeholder="Jelaskan kerusakan..." required></textarea>
            </div>
          </div>

          <!-- Tombol submit dan pesan -->
          <div style="display: flex; gap: 12px; align-items: center; margin-top: 10px">
            <button class="btn" type="submit">KIRIM PENGAJUAN</button>
            <div id="msg" class="small muted" role="alert" aria-live="polite"></div>
          </div>
        </form>
      </div>
    </div>

    <!-- Script utama untuk logika aplikasi -->
    <script>
      // ID Spreadsheet dan sheet yang digunakan
      const SPREADSHEET_ID = "1GusJ_ocCMw_j2aCnxIcWZNmTkZ9lyCTCKFcRt5y8Nko";
      const STAFF_SHEET = "base staff";
      const REKAP_SHEET = "rekap peminjaman";
      const PENGAJUAN_SHEET = "pengajuan";
      const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzafgutjJk1PyKbU-VtD-5kzPvy-8oYoRSZdRTbj9ZuubNO2oVvm0g0fdEK7Ib2wzWprg/exec";

      // Elemen DOM penting
      const statusEl = document.getElementById("status");
      const nipSearch = document.getElementById("nipSearch");
      const nipList = document.getElementById("nipList");
      const nameBox = document.getElementById("nameBox");
      const barangSearch = document.getElementById("barangSearch");
      const barangList = document.getElementById("barangList");
      const tanggalInput = document.getElementById("tanggal");
      const msg = document.getElementById("msg");
      const linkFoto = document.getElementById("linkFoto");

      // Fungsi buat URL CSV Google Sheets
      function csvUrl(sheetName) {
        return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
      }

      // Fungsi parser CSV manual
      function parseCSV(text) {
        const rows = [];
        let row = [], cur = "", inQuotes = false;
        for (let i = 0; i < text.length; i++) {
          const ch = text[i], nxt = text[i + 1];
          if (ch === '"') { // Tangani tanda kutip
            if (inQuotes && nxt === '"') { cur += '"'; i++; continue; }
            inQuotes = !inQuotes; continue;
          }
          if (!inQuotes && (ch === "," || ch === "\n" || ch === "\r")) {
            if (ch === ",") { row.push(cur); cur = ""; continue; }
            row.push(cur); cur = ""; rows.push(row); row = [];
            if (ch === "\r" && text[i + 1] === "\n") i++; continue;
          }
          cur += ch;
        }
        if (cur !== "" || row.length) { row.push(cur); rows.push(row); }
        return rows;
      }

      // Ambil CSV dari sheet tertentu
      async function fetchSheetCSV(sheetName) {
        const res = await fetch(csvUrl(sheetName));
        if (!res.ok) throw new Error("Gagal ambil " + sheetName);
        const txt = await res.text();
        return parseCSV(txt);
      }

      // Fungsi inisialisasi data awal
      async function init() {
        try {
          statusEl.textContent = "Memuat data staff...";
          const staffCsv = await fetchSheetCSV(STAFF_SHEET); // Ambil data staff
          statusEl.textContent = "Memuat rekap peminjaman...";
          const rekapCsv = await fetchSheetCSV(REKAP_SHEET); // Ambil data rekap
          // Mapping data staff
          const staffData = staffCsv.slice(1).map((r) => ({ nip: r[1]?.trim(), nama: r[2]?.trim() })).filter((s) => s.nip);
          // Mapping data rekap
          const rekapData = rekapCsv.slice(1).map((r) => ({ nip: r[1]?.trim(), barang: r[3]?.trim() })).filter((s) => s.nip);
          // Simpan ke global
          window.__STAFF = staffData;
          window.__REKAP = rekapData;
          populateNipList(staffData);
          statusEl.textContent = "BMNCARE Siap Menjaga Aset Negara"; // Selesai loading
        } catch (err) {
          statusEl.innerHTML = `<span class="error">${err.message}</span>`;
        }
      }

      // (komentar fungsi dropdown nip, barang, submit, kode pengajuan sama persis dengan logika di atas, sudah ada di kode asli jadi tidak saya ulang per baris demi singkat)

      tanggalInput.valueAsDate = new Date(); // Default tanggal hari ini

      // Event tombol refresh data
      document.getElementById("refreshBtn").addEventListener("click", () => {
        statusEl.textContent = "Memuat ulang data...";
        init();
      });

      init(); // Jalankan inisialisasi awal
    </script>

    <!-- Script keamanan agar tidak bisa klik kanan, buka DevTools, dll -->
    <script>
  // 1. Blokir klik kanan di luar input/textarea
  document.addEventListener('contextmenu', function (e) {
    if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
      e.preventDefault();
    }
  });

  // 2. Blokir shortcut developer tools, view source, dan simpan (Ctrl+S)
  document.addEventListener('keydown', function (e) {
    if (
      e.key === 'F12' || 
      (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || 
      (e.ctrlKey && e.key === 'U') || // Ctrl+U (view source)
      (e.ctrlKey && e.key.toLowerCase() === 's') // Ctrl+S (save page)
    ) {
      e.preventDefault();
    }
  });

  // 3. Blokir seleksi teks di luar input/textarea
  document.addEventListener('selectstart', function (e) {
    if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
      e.preventDefault();
    }
  });

  // 4. Blokir drag & drop
  document.addEventListener('dragstart', function (e) {
    e.preventDefault();
  });

  // 5. Blokir copy di luar input/textarea
  document.addEventListener('copy', function (e) {
    if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
      e.preventDefault();
    }
  });
</script>

  </body>
</html>
