<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BMNCARE</title>

    <!-- Link ke CSS eksternal -->
    <link rel="stylesheet" href="css/bmncare.css" />

    <!-- Favicon -->
    <link rel="icon" href="images/bmncare2.ico" type="image/x-icon">
  </head>
  <body>

    <!-- Script validasi akses halaman -->
    <script>
      if (localStorage.getItem("izinbmncare") !== "ya") {
        alert("Akses ditolak. Silakan buka halaman BMNCARE.");
        window.location.href = "https://bmncare.github.io/";
      } else {
        localStorage.removeItem("izinbmncare");
      }
    </script>

    <!-- Wrapper utama -->
    <div class="wrap">
      <header>
        <div>
          <h1>BMNCARE - Form Pengajuan Perbaikan</h1>
          <p class="lead">"Menjaga Aset, Membangun Negeri"</p>
        </div>
      </header>

      <!-- Card utama untuk form -->
      <div class="card">
        
        <!-- Status data + tombol refresh -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div id="status" class="small muted">Memuat data...</div>
          <button id="refreshBtn" class="btn-refresh" title="Muat ulang data">&#x21bb;</button>
        </div>

        <!-- Form pengajuan -->
        <form id="bmncareForm" onsubmit="return handleSubmit(event)" autocomplete="off">
          <div class="row">
            
            <!-- Pilih NIP -->
            <div class="input-container">
              <label for="nipSearch">Pilih NIP & Nama</label>
              <input id="nipSearch" placeholder="Ketik untuk mencari NIP..." autocomplete="off" required />
              <div id="nipList" class="dropdown-list"></div>
            </div>

            <!-- Nama otomatis -->
            <div>
              <label for="nameBox">Nama</label>
              <input id="nameBox" readonly placeholder="Nama akan muncul otomatis" />
            </div>

            <!-- Pilih barang -->
            <div class="input-container">
              <label for="barangSearch">Barang</label>
              <input id="barangSearch" placeholder="Ketik untuk mencari barang..." autocomplete="off" required disabled />
              <div id="barangList" class="dropdown-list"></div>
            </div>

            <!-- Tanggal laporan -->
            <div>
              <label for="tanggal">Tanggal Laporan</label>
              <input id="tanggal" type="date" required />
            </div>

            <!-- Link foto opsional -->
            <div class="full">
              <label for="linkFoto">Link Foto (opsional)</label>
              <input id="linkFoto" type="url" placeholder="Masukkan URL foto, boleh dikosongkan" />
            </div>

            <!-- Keterangan kerusakan -->
            <div class="full">
              <label for="keterangan">Keterangan Kerusakan</label>
              <textarea id="keterangan" placeholder="Jelaskan kerusakan..." required></textarea>
            </div>
          </div>

          <!-- Tombol kirim + pesan status -->
          <div style="display: flex; gap: 12px; align-items: center; margin-top: 10px">
            <button class="btn" type="submit">KIRIM PENGAJUAN</button>
            <div id="msg" class="small muted" role="alert" aria-live="polite"></div>
          </div>
        </form>
      </div>
    </div>

    <!-- Script utama untuk fetch data & submit -->
    <script>
      // === KONFIGURASI DASAR ===
      const SPREADSHEET_ID = "1GusJ_ocCMw_j2aCnxIcWZNmTkZ9lyCTCKFcRt5y8Nko";
      const STAFF_SHEET = "base staff";
      const REKAP_SHEET = "rekap peminjaman";
      const PENGAJUAN_SHEET = "pengajuan";
      const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzafgutjJk1PyKbU-VtD-5kzPvy-8oYoRSZdRTbj9ZuubNO2oVvm0g0fdEK7Ib2wzWprg/exec";

      // Ambil elemen DOM penting
      const statusEl = document.getElementById("status");
      const nipSearch = document.getElementById("nipSearch");
      const nipList = document.getElementById("nipList");
      const nameBox = document.getElementById("nameBox");
      const barangSearch = document.getElementById("barangSearch");
      const barangList = document.getElementById("barangList");
      const tanggalInput = document.getElementById("tanggal");
      const msg = document.getElementById("msg");
      const linkFoto = document.getElementById("linkFoto");

      // === HELPER UNTUK FETCH DATA ===
      function csvUrl(sheetName) {
        return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
      }

      // Parsing CSV manual
      function parseCSV(text) {
        const rows = [];
        let row = [], cur = "", inQuotes = false;
        for (let i = 0; i < text.length; i++) {
          const ch = text[i], nxt = text[i + 1];
          if (ch === '"') {
            if (inQuotes && nxt === '"') {
              cur += '"'; i++; continue;
            }
            inQuotes = !inQuotes; continue;
          }
          if (!inQuotes && (ch === "," || ch === "\n" || ch === "\r")) {
            if (ch === ",") { row.push(cur); cur = ""; continue; }
            row.push(cur); cur = ""; rows.push(row); row = [];
            if (ch === "\r" && text[i + 1] === "\n") i++;
            continue;
          }
          cur += ch;
        }
        if (cur !== "" || row.length) { row.push(cur); rows.push(row); }
        return rows;
      }

      // Ambil data dari Google Sheets
      async function fetchSheetCSV(sheetName) {
        const res = await fetch(csvUrl(sheetName));
        if (!res.ok) throw new Error("Gagal ambil " + sheetName);
        const txt = await res.text();
        return parseCSV(txt);
      }

      // === INISIALISASI DATA ===
      async function init() {
        try {
          statusEl.textContent = "Memuat data staff...";
          const staffCsv = await fetchSheetCSV(STAFF_SHEET);

          statusEl.textContent = "Memuat rekap peminjaman...";
          const rekapCsv = await fetchSheetCSV(REKAP_SHEET);

          // Mapping data staff
          const staffData = staffCsv
            .slice(1)
            .map((r) => ({ nip: r[1]?.trim(), nama: r[2]?.trim() }))
            .filter((s) => s.nip);

          // Mapping data barang
          const rekapData = rekapCsv
            .slice(1)
            .map((r) => ({ nip: r[1]?.trim(), barang: r[3]?.trim() }))
            .filter((s) => s.nip);

          window.__STAFF = staffData;
          window.__REKAP = rekapData;

          // Isi dropdown NIP
          populateNipList(staffData);
          statusEl.textContent = "BMNCARE Siap Menjaga Aset Negara";
        } catch (err) {
          statusEl.innerHTML = `<span class="error">${err.message}</span>`;
        }
      }

      // Fungsi refresh manual
      document.getElementById("refreshBtn").addEventListener("click", () => {
        statusEl.textContent = "Memuat ulang data...";
        init();
      });

      // Jalankan pertama kali
      init();
    </script>

    <!-- Script tambahan: blokir interaksi -->
    <script>
      // 1. Blokir klik kanan (kecuali input/textarea)
      document.addEventListener('contextmenu', function (e) {
        if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
          e.preventDefault();
        }
      });

      // 2. Blokir shortcut Developer Tools + View Source + Save (Ctrl+S)
      document.addEventListener('keydown', function (e) {
        if (
          e.key === 'F12' || 
          (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || 
          (e.ctrlKey && e.key === 'U') || 
          (e.ctrlKey && e.key === 's') // ðŸ”’ tambahan blokir Ctrl+S
        ) {
          e.preventDefault();
        }
      });

      // 3. Blokir seleksi teks (kecuali input/textarea)
      document.addEventListener('selectstart', function (e) {
        if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
          e.preventDefault();
        }
      });

      // 4. Blokir drag & drop
      document.addEventListener('dragstart', function (e) {
        e.preventDefault();
      });

      // 5. Blokir copy (kecuali input/textarea)
      document.addEventListener('copy', function (e) {
        if (!['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
          e.preventDefault();
        }
      });
    </script>

  </body>
</html>
